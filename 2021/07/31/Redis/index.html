<!DOCTYPE HTML>
<html lang="zh-CN">



<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis, 瀚77的博客">
    <meta name="description" content="本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis | 瀚77的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="瀚77的博客" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>








<body>

    

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">瀚77的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">瀚77的博客</div>
        <div class="logo-desc">
            
            本网站是个人兴趣爱好，总结分享经验，记录生活点滴的平台，希望在以后的学习旅途中，走出自己的风景。
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Redis/" class="post-category">
                                Redis
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-31
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-18
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    17.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    70 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="NoSQL数据库简介"><a href="#NoSQL数据库简介" class="headerlink" title="NoSQL数据库简介"></a>NoSQL数据库简介</h2><h3 id="技术发展"><a href="#技术发展" class="headerlink" title="技术发展"></a>技术发展</h3><ul>
<li>解决功能性问题：java，jsp，tomcat，html，Linux</li>
<li>解决扩展性的问题：Spring、SpringMVC、MyBatis</li>
<li>解决性能问题：NoSQL，java线程，Nginx</li>
</ul>
<h3 id="NoSQL简介"><a href="#NoSQL简介" class="headerlink" title="NoSQL简介"></a>NoSQL简介</h3><p>NoSQL（==Not Only SQL==），意为“不仅仅是SQL”，泛指<strong>非关系型数据库</strong>。</p>
<p>NoSQL不依赖业务逻辑方式存储，而以简单的key–value模式存储，因此大大的增加了数据库的扩展能力。</p>
<p><strong>其打破了传统的关系型数据库以业务逻辑为依据进行的存储方式，而是针对不同数据结构类型，改变以性能为优先的存储方式</strong></p>
<p>特点：</p>
<ul>
<li>不遵循SQL标准</li>
<li>远超于SQL性能，因为不依赖业务逻辑，只是单纯的key–value</li>
</ul>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>对数据高并发的读写，比如秒杀</li>
<li>对海量数据的高效率存储和访问</li>
<li>对数据库的高可扩展性和高可用性</li>
</ul>
<h3 id="不适用场景"><a href="#不适用场景" class="headerlink" title="不适用场景"></a>不适用场景</h3><ul>
<li>需要事务支持</li>
<li>基于sql的结构化查询存储，处理复杂的关系</li>
</ul>
<p>简言之一句话：==<strong>用不着sql的和用了sql也不行的情况，请考虑用NoSQL</strong>==</p>
<p>行式存储数据库：每一行都当做一块来存储，优势：查询数据很快等</p>
<p>列式存储数据库：每一列都当做一块来存储，优势：求平均值很快等</p>
<p>【补充：】</p>
<p>1TB (Trillionbyte 万亿字节 太字节)=1024GB</p>
<p>1PB（Petabyte 千万亿字节 拍字节）=1024TB，</p>
<p>1EB（Exabyte 百亿亿字节 艾字节）=1024PB，</p>
<p>1ZB (Zettabyte 十万亿亿字节 泽字节)= 1024 EB,</p>
<p>1YB (Jottabyte 一亿亿亿字节 尧字节)= 1024 ZB,</p>
<p>1BB (Brontobyte 一千亿亿亿字节)= 1024 YB.</p>
<h2 id="Redis-1"><a href="#Redis-1" class="headerlink" title="Redis"></a>Redis</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li><p>Redis是一个开源的key – value存储系统</p>
</li>
<li><p>和Memcached 类似，但它支持存储value类型相对更多，包括string(字符串)，list(链表)，set(集合)，Zset(有序集合) 和hash(哈希类型)</p>
</li>
<li><p>这些数据类型都支持push /pop 、add/remove 及取交集并集和差集以及更丰富的操作，而这些<strong>操作都是原子性的</strong>。</p>
</li>
<li><p>在此基础上，Redis支持各种不同方式的排序</p>
</li>
<li><p>为了保证效率，<strong>数据都是缓存在内存中</strong>。</p>
</li>
<li><p>Redis会周期性的把更新的数据写入磁盘或者把写入、修改操作追加到记录文件。</p>
</li>
<li><p>并且在此基础上实现了master—slave(主从)同步。</p>
</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul>
<li>配合关系型数据库做高速缓存<ul>
<li>高频次，热门访问的数据，降低数据库IO</li>
<li>分布式架构，做session共享</li>
</ul>
<img src="/images/QQ%E6%88%AA%E5%9B%BE20210803093645.png"></li>
<li>多样的数据结构存储持久化数据</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210803093707.png"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li><p>redis-6.2.1.tar.gz  放到  /opt/   下</p>
</li>
<li><p>yum install gcc   下载gcc</p>
</li>
<li><p>tar -zxvf  redis-6.2.1.tar.gz   解压</p>
</li>
<li><p>make   编译为c的文件</p>
</li>
<li><p>make install   安装</p>
</li>
<li><p>默认在  /usr/local/bin</p>
</li>
</ul>
<p>安装目录下各个文件的作用：</p>
<p>redis-benchmark:性能测试工具</p>
<p>redis-check-aof：修复有问题的AOF文件</p>
<p>redis-check-dump：修复有问题的dump.rdb文件</p>
<p>redis-sentinel：Redis集群使用</p>
<p>redis-server：Redis服务器启动命令</p>
<p>redis-cli：客户端，操作入口</p>
<p>前台启动  :  redis–server</p>
<p>后台启动：</p>
<ul>
<li><p>cp  /opt/redis-6.2.5/redis.conf  /etc/redis.conf</p>
</li>
<li><p>vim  /etc/redis.conf    ，把 daemonize   no  改为   daemonize   yes </p>
<p>【补充：】  vim的命令行模式下输入   /daemonize    即可搜索需要的内容</p>
</li>
<li><p>cd  /usr/local/bin/</p>
</li>
<li><p>reids-server  配置文件所在位置        就可以启动服务</p>
</li>
<li><p> redis-cli  [ -p  端口号]                        可以连接客户端</p>
</li>
<li><p>若是要启动多个redis，需要在启动服务的时候表明自己用的是哪个配置文件，还有必须指定自己的端口号</p>
</li>
<li><p>关闭：   redis-cil  shutdown  或者  kill -9  进程号</p>
<p>多实例关闭，指定端口关闭:  redis-cli -p &lt;端口号&gt;shutdown</p>
</li>
</ul>
<h3 id="Redis占用内存大小"><a href="#Redis占用内存大小" class="headerlink" title="Redis占用内存大小"></a>Redis占用内存大小</h3><p>​      我们知道Redis是基于内存的key-value数据库，因为系统的内存大小有限，所以我们在使用Redis的时候可以配置Redis能使用的最大的内存大小</p>
<ul>
<li><p>通过配置文件配置</p>
</li>
<li><p>redis配置文件中，修改    maxmemory  后面的值即可</p>
</li>
<li><p>通过命令修改</p>
<pre class=" language-shell"><code class="language-shell">//设置Redis最大占用内存大小为100M
127.0.0.1:6379> config set maxmemory 100mb
//获取设置的Redis能使用的最大内存大小
127.0.0.1:6379> config get maxmemory
</code></pre>
<p>​    如果不设置最大内存大小或者设置最大内存大小为0，在64位操作系统下不限制内存大小，在32位操作系统下最多使用3GB内存</p>
</li>
</ul>
<h4 id="Redis的内存淘汰"><a href="#Redis的内存淘汰" class="headerlink" title="Redis的内存淘汰"></a>Redis的内存淘汰</h4><p>​    既然可以设置Redis最大占用内存大小，那么配置的内存就有用完的时候。那在内存用完的时候，还继续往Redis里面添加数据不就没内存可用了吗？</p>
<p>实际上Redis定义了几种策略来处理这种情况：</p>
<ul>
<li>noeviction(默认) ： 对于写请求不再提供服务，直接返回错误，DEL请求和部分特殊请求除外</li>
<li>allkeys-lru：从所有key中使用LRU(最近最少使用)算法进行淘汰</li>
<li>volatile-lru：从设置了过期时间的key中使用LRU算法淘汰</li>
<li>allkeys-random：从所有key中随机淘汰</li>
<li>volatile-random：从设置了过期时间的key中随机淘汰</li>
<li>volatile-ttl：在设置了过期时间的key中，根据key 的过期时间进行淘汰，越快过期的越优先淘汰</li>
</ul>
<p>当使用volatile-lru、volatile-random、volatile-ttl这三种策略时，如果没有key可以被淘汰，则和noeviction一样返回错误</p>
<h4 id="设置内存淘汰策略"><a href="#设置内存淘汰策略" class="headerlink" title="设置内存淘汰策略"></a>设置内存淘汰策略</h4><ul>
<li>获取当前内存淘汰策略</li>
</ul>
<pre class=" language-shell"><code class="language-shell">127.0.0.1:6379> config get maxmemory-policy
</code></pre>
<ul>
<li>通过配置文件设置淘汰策略</li>
</ul>
<pre class=" language-shell"><code class="language-shell">maxmemory-policy allkeys-lru
</code></pre>
<ul>
<li>通过命令修改淘汰策略：</li>
</ul>
<pre class=" language-shell"><code class="language-shell">127.0.0.1:6379> config set maxmemory-policy allkeys-lru
</code></pre>
<p>【补充：LRU算法】</p>
<p>​    LRU(Least Recently Used)，即最近最少使用，是一种缓存置换算法。在使用内存作为缓存的时候，缓存的大小一般是固定的。当缓存被占满，这个时候继续往缓存里面添加数据，就需要淘汰一部分老的数据，释放内存空间用来存储新的数据。这个时候就可以使用LRU算法了。其核心思想是：如果一个数据在最近一段时间没有被用到，那么将来被使用到的可能性也很小，所以就可以被淘汰掉。</p>
<p>​     Redis 中的 LRU 不是严格意义上的LRU算法实现，是一种近似的 LRU 实现，主要是为了节约内存占用以及提升性能。Redis 配置文件有这样一个配置 —— <code>maxmemory-samples</code>，Redis 的 LRU 是取出配置的数目(默认的是5)的key，然后从中选择一个最近最久未使用的 key 进行置换。可以通过调整样本数量来取得 LRU 置换算法的速度或是精确性方面的优势。Redis 不采用真正的 LRU 实现的原因是为了节约内存使用</p>
<h3 id="Redis介绍相关知识"><a href="#Redis介绍相关知识" class="headerlink" title="Redis介绍相关知识"></a>Redis介绍相关知识</h3><p>端口 6379 的由来，它是根据 Merz  这个名字来的，九键输入法的  M  e  r  z  四个字母对应着  6  3  7  9 四个数字</p>
<ul>
<li>Redis默认有16个数据库 0 - 15，默认是 0 号库</li>
<li>使用  select  &lt;库的编号&gt;   来切换库</li>
<li>统一密码管理，所有库有着同样的密码</li>
</ul>
<p>==<strong>Redis是单线程 + 多路 IO 复用技术</strong>==</p>
<p>​       多路复用是指使用一个线程来检查多个文件描述符( Socket )的就绪状态,比如调用select和epoll函数,传入多个文件描述符,如果有一个文件描述符就绪,则返回,否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行,也可以启动新的线程执行(比如使用线程池)。也就是<strong>单个线程，跟踪、管理多个I/O流 。</strong></p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801005200.png"></p>
<p>在黄牛买到票之前， 1,2,3号他们还是干自己的事情，这就是多路 IO 复用，提高CPU利用率</p>
<p>Redis与Memcache的三点不同：支持多数据类型，支持持久化，单线程 + 多路 IO 复用</p>
<h4 id="Redis-key键操作"><a href="#Redis-key键操作" class="headerlink" title="Redis key键操作"></a>Redis key键操作</h4><ul>
<li><p>keys *  </p>
<ul>
<li>查看当前所有库</li>
</ul>
</li>
<li><p>exists  key</p>
<ul>
<li>判断某个key是否存在</li>
</ul>
</li>
<li><p>type key</p>
<ul>
<li>查看你的key对应的value是什么类型</li>
</ul>
</li>
<li><p>del key</p>
<ul>
<li>删除指定的key数据</li>
</ul>
</li>
<li><p>unlink  key</p>
<ul>
<li><strong>根据value选择非阻塞删除</strong>，也就是仅将key从keyspace元数据中删除，<strong>真正的删除会在后续异步操作</strong></li>
</ul>
</li>
<li><p>expire key  时间</p>
<ul>
<li>为给定的key设置过期时间，单位为秒，若是没有设置过期时间，则默认永不过期</li>
</ul>
</li>
<li><p>ttl  key</p>
<ul>
<li>查看还有多少秒过期，-1表示永不过期，-2表示已经过期</li>
</ul>
</li>
<li><p>select  库编号</p>
<ul>
<li>切换数据库</li>
</ul>
</li>
<li><p>dbsize </p>
<ul>
<li>查看当前数据库的key的数量</li>
</ul>
</li>
<li><p>flushdb 和  flushall</p>
<ul>
<li>清空当前库</li>
</ul>
</li>
</ul>
<h3 id="Redis常用数据类型"><a href="#Redis常用数据类型" class="headerlink" title="Redis常用数据类型"></a>Redis常用数据类型</h3><p>==<strong>常用数据类型都是针对于key - value 的value来说的</strong>==，这个value可以是string，list，set，hash。。。</p>
<h4 id="Redis字符串-String"><a href="#Redis字符串-String" class="headerlink" title="Redis字符串(String)"></a>Redis字符串(String)</h4><ul>
<li>简介<ul>
<li>String是Redis最基本的类型,你可以理解成与Memcached 一模一样的类型， 一个key对应一个value。</li>
<li>String类型是<strong>二进制安全的</strong>。 意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。只要能变成字符串就都能存到String里面去。</li>
<li><strong>String类型是Redis最基本的数据类型,</strong> 一个Redis中字符串value 最多可以是==<strong>512M</strong>==。</li>
</ul>
</li>
</ul>
<ul>
<li>常用命令<ul>
<li>set  &lt;key&gt;  &lt;value&gt;<ul>
<li> 添加键值对。如果key不为空，则达到一个覆盖的效果</li>
</ul>
</li>
<li>get  &lt;key&gt;   <ul>
<li>查询对应键的值</li>
</ul>
</li>
<li>getset  &lt;key&gt;  &lt;value&gt;   <ul>
<li> 以旧换新，设置新值的同时返回旧值</li>
</ul>
</li>
<li>append   &lt;key&gt;  &lt;value&gt;  <ul>
<li>将给定的 &lt;valule&gt; 追加到原值的末尾</li>
</ul>
</li>
<li>strlen  &lt;key&gt; <ul>
<li>获得值的长度</li>
</ul>
</li>
<li>setnx   &lt;key&gt;  &lt;value&gt;  <ul>
<li>只有key不存在时才能设置key的值</li>
</ul>
</li>
<li>setex  &lt;key&gt; 过期时间  &lt;value&gt;    <ul>
<li>添加数据的时候就设置过期时间，expire 是为已存在的key设置过期时间，注意区别</li>
</ul>
</li>
<li>incr  &lt;key&gt; <ul>
<li>将key中存储的数字值增1，<strong>只能对数字值操作</strong>，如果key为空，则新增值为1</li>
</ul>
</li>
<li>decr  &lt;key&gt; <ul>
<li>将key中存储的数字值减1</li>
</ul>
</li>
<li>incrby\decrby  &lt;key&gt; &lt;步长&gt; <ul>
<li> 将key中存储的数字值根据自定义步长增减</li>
</ul>
</li>
<li>mset  &lt;key1&gt;  &lt;value1&gt;  &lt;key2&gt;  &lt;value2&gt;  …   &lt;key n&gt;&lt;value n&gt;  <ul>
<li>添加多个值</li>
</ul>
</li>
<li>mget  &lt;key1&gt; &lt;key2&gt; …   &lt;key n&gt; <ul>
<li>查看多个值</li>
</ul>
</li>
<li>msetnx    &lt;key1&gt;  &lt;value1&gt;  &lt;key2&gt;  &lt;value2&gt;  …   &lt;key n&gt;&lt;value n&gt;    <ul>
<li>当且仅当添加的key都不存在时才成功</li>
</ul>
</li>
<li>getrange &lt;key&gt; &lt;起始位置&gt; &lt;结束位置&gt;      <ul>
<li>截取范围  [起始位置，结束位置]  内的值。开始索引为0</li>
</ul>
</li>
<li>setrange  &lt;key&gt; &lt;起始位置&gt; &lt;value&gt;   <ul>
<li>从起始位置开始(开始索引为0)，用 &lt;value&gt;覆盖原来的值， &lt;value&gt;有几位就覆盖几位，覆盖不了的还是显示旧 &lt;value&gt;的值</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Redis单命令是原子性的</p>
<ul>
<li>原子操作是指不会被线程调度机制打断的操作，这种操作一旦开始，就一直运行到结束，中间不会有任何context switch</li>
<li><strong>在单线程中，能够在单条指令中完成的操作都可以认为是“原子操作”，因为中断只发生在指令之间</strong></li>
<li>在多线程中，不能被其他进程或线程打断的操作就叫原子操作</li>
<li>==<strong>Redis单命令的原子性主要得益于Redis是单线程的</strong>==</li>
</ul>
<p>【补充问题：】</p>
<p>java中的 i++ 是否是原子操作？ 答案：不是</p>
<p>i = 0； 两个线程分别对i进行 ++100次，值是多少？   答案 ： 2 ~ 200 之间都有可能</p>
<p>分析：</p>
<table>
<thead>
<tr>
<th>a线程</th>
<th>b线程</th>
</tr>
</thead>
<tbody><tr>
<td>i = 0</td>
<td>i = 0</td>
</tr>
<tr>
<td>i++</td>
<td>被a打断</td>
</tr>
<tr>
<td>…  到 i=99</td>
<td>被a打断</td>
</tr>
<tr>
<td>被b打断</td>
<td>i++</td>
</tr>
<tr>
<td>被b打断</td>
<td>i = 1</td>
</tr>
<tr>
<td>i = 1</td>
<td>被a打断</td>
</tr>
<tr>
<td>被b打断</td>
<td>i ++</td>
</tr>
<tr>
<td>被b打断</td>
<td>直到   i = 100</td>
</tr>
<tr>
<td>i ++</td>
<td>b结束</td>
</tr>
<tr>
<td>i = 2</td>
<td>b结束</td>
</tr>
</tbody></table>
<p>底层数据结构</p>
<p>​     String的数据结构为<strong>简单动态字符串</strong>，是可以修改的字符串，内部结构实现上类似于java的ArrayList，采用预分配冗余空间的方式来减少内存频繁分配，内部为当前字符串分配的空间一般要高于实际字符串长度len。当字符串长度小于 1M 时，扩容都是加倍现有的空间，如果超过 1M ，扩容时一次只会增加 1M 的空间，需要注意的是<strong>字符串最大长度为 512M</strong>。</p>
<h4 id="Redis列表-List"><a href="#Redis列表-List" class="headerlink" title="Redis列表(List)"></a>Redis列表(List)</h4><p>简介：</p>
<p>​    Redis列表是简单的字符串列表，按照插入顺序排序，可以添加一个元素到列表的头部（左边）或者尾部（右边），它的底层实际上是==<strong>双向列表</strong>==，对两端的操作性能很高，通过索引下标操作中间的结点性能会较差</p>
<p>常用命令</p>
<ul>
<li><p>lpush/rpush   &lt;key1&gt;  &lt;value1&gt;  &lt;value2&gt;  …  &lt;value n&gt;  </p>
<ul>
<li>从左边/右边插入一个或多个值</li>
<li>lpush 是从最左边放值，一个挤一个的放，把第一个挤到最后一个</li>
<li>rpush 是从最右边放值，也就是顺序放</li>
</ul>
</li>
<li><p>lpop/rpop   &lt;key1&gt;  [count]</p>
<ul>
<li>从左边/右边吐出count个值，==<strong>值有键在，值无键亡</strong>==</li>
</ul>
</li>
<li><p>rpoplpush  &lt;key1&gt;  &lt;key2&gt;</p>
<ul>
<li>从&lt;key1&gt; 列表右边吐出一个值，插入到 &lt;key2&gt; 列表左边，没有   lpoprpush   这条指令</li>
</ul>
</li>
<li><p>lrange &lt;key1&gt;  &lt;start&gt;  &lt;stop&gt; </p>
<ul>
<li>按照索引下标获取元素（从左到右） </li>
<li>lrange key 0  -1   表示获取key的所有值</li>
</ul>
</li>
<li><p>lindex  &lt;key&gt; &lt;index&gt; </p>
<ul>
<li>按照索引下标（从0开始）获得元素（从左到右）</li>
</ul>
</li>
<li><p>llen  &lt;key&gt;  </p>
<ul>
<li>获取列表长度</li>
</ul>
</li>
<li><p>linsert &lt;key&gt; before/after  &lt;value&gt;  &lt;newvalue&gt;</p>
<ul>
<li>在 &lt;value&gt;的前面/后面插入  &lt;newvalue&gt; </li>
</ul>
</li>
<li><p>lrem  &lt;key&gt;  &lt;n&gt;  &lt;value&gt; </p>
<ul>
<li>从左边删除n个value（从左到右）</li>
</ul>
</li>
<li><p>lset  &lt;key&gt;  &lt;index&gt;  &lt;value&gt; </p>
<ul>
<li>将列表key下标为index(从0开始)的值替换成value</li>
</ul>
</li>
</ul>
<p>底层数据结构</p>
<p>​    List的数据结构为快速链表quickList。首先在列元素较少的情况下会使用一块连续的空间,这个结构是ziplist ,也即是<br>压缩列表。它将所有的元素紧挨着一起存储,分配的是一块连续的内存。当数据量比较多的时候才会改成quicklist。</p>
<p>​    因为普通的链表需要的附加指针空间太大,比较浪费空间。比如这个列表里存的只是int类型的数据结构，它还需要两个额外的指针prev和next.。</p>
<p>​    Redis将链表和ziplist结合起来组成了quicklist.也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能,又不会出现太大的空间冗余。</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801091812.png"></p>
<h4 id="Redis集合（set）"><a href="#Redis集合（set）" class="headerlink" title="Redis集合（set）"></a>Redis集合（set）</h4><p>简介<br>    Redis set对外提供的功能与list类似也是一个列表的功能 ,特殊之处在于set是可以<strong>自动排重</strong>，当你需要存储一个列表数据，又不希望出现重复数据时, set是一个很好的选择，并且set提供了判断某个成员否在一个set集合内的重要接口,这个也是list所不能提供的。</p>
<p>​    Redis的Set是string类型的无序集合。它<strong>底层是一个value为null的hash表</strong>，所以添加,删除,查找的复杂度都是**0(1)**。集合中数据增加，查找数据的时间还是不变。</p>
<p>常用命令</p>
<ul>
<li><p>sadd  &lt;key&gt;   &lt;value1&gt;  &lt;value2&gt; ….</p>
<ul>
<li>将一个或多个值添加到集合key中，已经存在的值是添加不进去的</li>
</ul>
</li>
<li><p>smembers   &lt;key&gt; </p>
<ul>
<li>取出该集合的所有值</li>
</ul>
</li>
<li><p>sismember  &lt;key&gt;  &lt;value&gt;</p>
<ul>
<li>判断集合&lt;key&gt;是否为含有该&lt;value&gt; 的值，有返回1，没有返回0</li>
</ul>
</li>
<li><p>scard  &lt;key&gt;</p>
<ul>
<li>返回该集合的元素个数</li>
</ul>
</li>
<li><p>srem &lt;key&gt; &lt;value1&gt; &lt;value2&gt;…</p>
<ul>
<li> 删除集合中的元素</li>
</ul>
</li>
<li><p>spop &lt;key&gt; </p>
<ul>
<li>随机从该集合中吐出一个值，意味着<strong>该元素从集合中删除</strong></li>
</ul>
</li>
<li><p>srandmember &lt;key&gt; &lt;n&gt;</p>
<ul>
<li>随机从该集合中取出n个值，<strong>不会从集合中删除</strong></li>
</ul>
</li>
<li><p>smove &lt;source&gt;  &lt;destination&gt; value</p>
<ul>
<li>把集合中的一个值从一个集合移动到另一个集合</li>
</ul>
</li>
<li><p>sinter &lt;key1&gt; &lt;key2&gt;</p>
<ul>
<li>返回两个集合的交集元素</li>
</ul>
</li>
<li><p>sunion  &lt;key1&gt;  &lt;key2&gt;</p>
<ul>
<li>返回两个集合的并集元素</li>
</ul>
</li>
<li><p>sdiff &lt;key1&gt; &lt;key2&gt;</p>
<ul>
<li>返回key1集合中的，key2集合中没有的差集元素</li>
</ul>
</li>
</ul>
<p>底层数据结构</p>
<p>​        Java中HashSet的内部实现使用的是HashMap ,只不过所有的value都指向同一个对象。</p>
<p>​       Redis的set结构也是一样,它的内部也使用hash结构。</p>
<h4 id="Redis哈希（hash）"><a href="#Redis哈希（hash）" class="headerlink" title="Redis哈希（hash）"></a>Redis哈希（hash）</h4><p> 简介：</p>
<p>Redis hash是一个键值对集合。 Redis hash是一个 string类型的field 和value的映射表, hash特别适合于存储对象。类似Java里面的Map&lt;String,Object&gt;。用户ID为查找的key，存储的value户对象包含姓名,年龄，生日等信息,</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801103427.png"></p>
<p>常用指令</p>
<ul>
<li><p>hset &lt;key&gt;  &lt;field&gt;   &lt;value&gt; </p>
<ul>
<li>给集合中的  &lt;key&gt;  赋值 &lt;value&gt; 到 &lt;filed&gt;键</li>
</ul>
</li>
<li><p>hget  &lt;key1&gt;  &lt;filed&gt; </p>
<ul>
<li>取出 &lt;key1&gt;集合 &lt;filed&gt;的值</li>
</ul>
</li>
<li><p>hmset  &lt;key1&gt;   &lt;filed1&gt; &lt;value1&gt;   &lt;field2&gt; &lt;value2&gt;</p>
<ul>
<li>批量设置hash值</li>
</ul>
</li>
<li><p>hexists   &lt;key1&gt;   &lt;field&gt;</p>
<ul>
<li>查看hash表key中给定域field是否存在，返回1表示存在，返回0表示没有</li>
</ul>
</li>
<li><p>hkeys   &lt;key&gt;</p>
<ul>
<li>列出该hash集合的所有field</li>
</ul>
</li>
<li><p>hvals   &lt;key&gt;</p>
<ul>
<li>列出该hash集合的所有value</li>
</ul>
</li>
<li><p>hincrby   &lt;key&gt;  &lt;field&gt; &lt;increment&gt; </p>
<ul>
<li>为哈希表 key 中的  filed  的值加上一个增量 increment</li>
</ul>
</li>
<li><p>hsetnx   &lt;key&gt;  &lt;field&gt; &lt;value&gt; </p>
<ul>
<li>为哈希表 key 中的  filed  的值加上一个增量 increment，<strong>当且仅当 field 不存在</strong></li>
</ul>
</li>
</ul>
<p>底层数据结构</p>
<p>​    Hash类型对应的数据结构是两种: ziplist (压缩列表)，hashtable (哈希表)。当field-value长度较短且个数较少时，使用ziplist,否则使用hashtable.。哈希对象使用ziplist编码需要满足两个条件：一是所有键值对的键和值的字符串长度都小于64字节；二是键值对数量小于512个；不满足任意一个都使用hashtable编码。</p>
<p>【回忆】：HashTable和HashMap区别</p>
<ul>
<li><p>继承：</p>
<ul>
<li>HashTable继承自Dirctionary，HashMap继承自AbstractMap，二者均实现了Map接口；</li>
</ul>
</li>
<li><p>线程安全性：</p>
<ul>
<li>HashTable的方法是同步的，即是线程安全的。HaspMap的方法不是同步的，不是线程安全的。在多线程并的情况下，我们可以直接使用HashTable，如果 要使用HashMap，就需要自行对HashMap的同步处理。</li>
</ul>
</li>
<li><p>键值：</p>
<ul>
<li>HashTable中不允许有null键和null值，HashMap中允许出现一个null键，可以存在一个或者多个键的值都为null。程序中，对于HashMap，如果使用get(参数为 键)方法时，返回结果为null，可能是该键不存在，也可能是该键对应的值为null，这就出现了结果的二义性。因此，在HashMap中，我们不能使用get()方法来查询键 对应的值，应该使用containskey()方法。</li>
</ul>
</li>
<li><p>哈希值：</p>
<ul>
<li>HashTable是直接使用对象的hashCode。HashMap是重新计算hash值。</li>
</ul>
</li>
<li><p>扩容：</p>
<ul>
<li>HashTable和HashMap的底层实现的数组和初始大小和扩容方式。HashTable初始大小为11，并且每次扩容都为：2 * old+1。HashMap的默认大小为16，并且一 定是2的指数，每次扩容都为old * 2。</li>
</ul>
</li>
</ul>
<h4 id="Redis有序集合Zset（sorted-set）"><a href="#Redis有序集合Zset（sorted-set）" class="headerlink" title="Redis有序集合Zset（sorted set）"></a>Redis有序集合Zset（sorted set）</h4><p>简介：</p>
<p>​        Redis有序集合Zset 与普通集合set非常相似，是一个<strong>没有重复元素</strong>的字符串集合。</p>
<p>​        不同之处是有序集合的每个成员都关联了一个评分( score) ，这个评分( score )被用来按照从最低分到最高分的方式排集合中的成员。</p>
<p>​        集合的成员是唯一的，但是评分可以是重复的。因为元素是有序的，所以也可以很快的根据评分( score )或者次序( position )来获取一个范围的元素。</p>
<p>​        访问有序集合的中间元素也是非常快的，因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<p>常用命令</p>
<ul>
<li><p>zadd &lt;key&gt; &lt;socre1&gt; &lt;value1&gt; &lt;score2&gt; &lt;value2&gt; …</p>
<ul>
<li>将一个或多个 member 元素及其score 值加入到有序集 key当中</li>
</ul>
</li>
<li><p>zrange &lt;key&gt; &lt;start&gt; &lt;stop&gt; [WITHSOCRES]</p>
<ul>
<li>返回有序集key中，下标在 &lt;start&gt;  &lt;stop&gt; 之间的元素，带WITHSOCRES，可以让分数一起和值返回到结果集</li>
<li>start 为 0 和 stop  为 -1  时，表示可以取出集合中的所有值</li>
</ul>
</li>
<li><p>zrangebyscore key min  max [withsocres] </p>
<ul>
<li>返回有序集key中，所有score值介于并包括 min 和 max之间的成员，有序集成员按score值从小到大排序</li>
</ul>
</li>
<li><p>zrevrangebyscore key  max  min  [withsocres] </p>
<ul>
<li>同上，改为从大到小</li>
</ul>
</li>
<li><p>zcount  &lt;key&gt;  &lt;min&gt;  &lt;max&gt; </p>
<ul>
<li>统计该集合分数区间内的元素个数</li>
</ul>
</li>
<li><p>zincrby &lt;key&gt;  &lt;increment&gt;  &lt;value&gt; </p>
<ul>
<li>为元素的score加上增量</li>
</ul>
</li>
<li><p>zrem  &lt;key&gt;  &lt;value&gt; </p>
<ul>
<li>删除该集合下指定值的元素</li>
</ul>
</li>
<li><p>zrank  &lt;key&gt;  &lt;value&gt; </p>
<ul>
<li>返回该值在集合中的排名，从0开始</li>
</ul>
</li>
</ul>
<p>底层数据结构</p>
<p>​        SortedSet (zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map&lt;String, Double&gt; ，可以给每一个元素 value赋予一个权重score ，另一方面它又类似于TreeSet ，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。<br>​    </p>
<p>​    zset底层使用了两个数据结构。</p>
<ul>
<li>hash <ul>
<li>hash的作用就是关联元素value和权重score，保障元素value的唯一性,可以通过元素value找到相应的score值。</li>
</ul>
</li>
<li>跳跃表<ul>
<li>跳跃表的目的在于给元素value排序和根据score的范围获取元素列表。<strong>文章最后有解释跳跃表</strong></li>
</ul>
</li>
</ul>
<h3 id="Redis的发布和订阅"><a href="#Redis的发布和订阅" class="headerlink" title="Redis的发布和订阅"></a>Redis的发布和订阅</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>Redis发布订阅（pub/sub）是一种消息通信模式：发送者（publish）发送消息，订阅者（subscribe）接收消息。</p>
<p>Redis客户端可以订阅任意数量的频道。</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801141145.png"></p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801141206.png"></p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801141509.png"></p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801141443.png"></p>
<h3 id="Redis新增数据类型"><a href="#Redis新增数据类型" class="headerlink" title="Redis新增数据类型"></a>Redis新增数据类型</h3><h4 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h4><p>简介：</p>
<p>现代计算机用二进制(位)作为信息的基础单位，1 个字等于8位，例如”abc”字符串是由3个字节组成，但实际在计算机存储时将其用二进制表示，”abc” 分别对应的ASCII码分别是97、98、 99， 对应的二进制分别是01100001、01100010和01100011。</p>
<p>合理地使用操作位能够有效地提高内存使用率和开发效率。Redis提供了Bitmaps这个“数据类型”可以实现对位的操作: 。<br>(1) Bitmaps本身不是一 种数据类型，实际上它就是字符串( key-value ),但是它可以对字符串的位进行操作。<br>(2) Bitmaps单独提供了一套命令，所以在Redis中使用Bitmaps和使用字符串的方法不太相同。可以把 Bitmaps 想象成一个以位为单位的数组,数组的每个单元只能存储0和1，数组的下标在Bitmaps中叫做偏移量。</p>
<p>常用命令：</p>
<ul>
<li><p>setbit &lt;key&gt; &lt;offest&gt; &lt;value&gt;</p>
<ul>
<li>设置Bitmaps中某个偏移量的值（0或1），offest的偏移量从0开始</li>
</ul>
</li>
<li><p>在第一次初始化Bitmaps时， 假如偏移量非常大， 那么整个初始化过程执行会比较慢， 可能会造成Redis的阻塞。</p>
</li>
<li><p>getbit &lt;key&gt; &lt;offest&gt;</p>
<ul>
<li>获取Bitmaps中某个偏移量的值</li>
</ul>
</li>
<li><p>bitcount </p>
<ul>
<li>统计字符串被设置为1的bit数。一般情况下，给定的整个字符串都会被进行计数，通过指定额外的start或end参数，可以让计数只在特定的位上进行。start 和end参数的设置，可以是负数值:如-1表示最后一个位，而-2表示倒数第个二位，start、end 是指<strong>bit组（代表8个bit）</strong>的字节的下标数，二者皆包含。</li>
<li>bitcount  &lt;key&gt; [start end]<ul>
<li>统计字符串从start字节(从0开始)到end字节的比特值为1的数量，<strong>注意是字节</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>bitop and/or/not/xor &lt;destkey&gt; [key…]</p>
<ul>
<li>bitop是一个复合操作，它可以做多个Bitmaps的and、or、not、xor操作并将结果保存在destkey中</li>
</ul>
</li>
</ul>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h4><p>简介：</p>
<p>​    在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV(PageView页面访问量) ，可以使用Redis的incr、incrby 轻松实现。</p>
<p>​    但像UV ( UniqueVisitor ,独位访客)、独立IP数、搜索记录数等要去重和计数的问题如何解决？这种求集合中不重复元素个数的问题称为基数问题。解决基数问题有很多种方案:</p>
<p>(1 )数据存储在MySQL中,使用distinct count计算不重复个数。</p>
<p>( 2)使佣Redis提供的hash、 set、bitmaps等数据结构来处理</p>
<p>   以上的方案结果精确，但随着数据不断增加，导致占用空间越来越大，对于非常大的数据集是不切实际的。</p>
<p>   能否能够降低一定的精度平衡存储空间？ Redis推出了HyperLogLog</p>
<p>   Redis HyperLogLog 用来做基数统计的算法，HyperLogLog的优点是,在输入元素的数量或者体积非常非常大时,计算基数所需的空间总是固定的、組是很小的。</p>
<p>   在Redis里面，每个HyperLogLog键只需要花费12 KB内存，就可以计算接近2^64个不同元素的基数。这和计算基数时，元素越多 耗费内存就越多的集合形成鲜明对比。</p>
<p>​    但是,因为HyperLogLog只会根据输入元素来计算基数,而不会储存输入元素本身,所以HyperLogLog不能像集合那样,返回输入的各个元素。</p>
<p>   什么是基数?。<br>    比如数据集{1, 3,5,7,5, 7, 8},那么这个数据集的基数集为{1, 3,5 ,7, 8},基数(不重复元素)为5个。基数估计就是在误差可接受的范围内 ,快速计算基数。</p>
<p>常用命令</p>
<ul>
<li><p>pfadd &lt;key&gt;  &lt;element&gt; [element…] </p>
<ul>
<li>添加指定元素到 HyperLogLog中，添加成功返回1，否则为0</li>
</ul>
</li>
<li><p>pfcount  &lt;key&gt;</p>
<ul>
<li>统计基数个数</li>
</ul>
</li>
<li><p>pfmerge  &lt;destkey&gt;   &lt;sourcekey&gt;   &lt;sourcekey&gt;  …</p>
<ul>
<li>将一个或多个 sourcekey 合并计算并存储在 destkey 中</li>
</ul>
</li>
</ul>
<h4 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h4><p>简介</p>
<p>​    Redis 3.2 中增加了对GEO型的支持。GEO , Geographic ,地理信息的缩写。该类型就是元素的2维坐标，在地图上就是经纬度，redis 基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<p>常用命令</p>
<ul>
<li><p>geoadd &lt;key&gt; &lt;longitude&gt;  &lt;latitude&gt;  &lt;member&gt;</p>
<ul>
<li>添加地理位置（经度，纬度，名称），可以添加多个</li>
</ul>
</li>
<li><p>geopos  &lt;key&gt;  &lt;member&gt;  </p>
<ul>
<li>获取指定地区的坐标值</li>
</ul>
</li>
<li><p>geodist   &lt;key&gt;   &lt;member1&gt;   &lt;member2&gt;   [m|km|ft|mi] </p>
<ul>
<li>获取两个位置之间的直线距离，单位默认是  m </li>
</ul>
</li>
<li><p>georadius  &lt;key&gt;   &lt;longitude&gt;  &lt;latitude&gt; radius    [m|km|ft|mi] </p>
<ul>
<li>以给定的半径找出此半径内的元素</li>
</ul>
</li>
</ul>
<h3 id="Jedis"><a href="#Jedis" class="headerlink" title="Jedis"></a>Jedis</h3><p>导入依赖</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//redis的所有命令都在jedis中有对应的方法，这里只显示了一部分</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisDemo1</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建Jedis对象</span>
        Jedis jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.130.172"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//测试连接</span>
<span class="token comment" spellcheck="true">//        String ping = jedis.ping();</span>
<span class="token comment" spellcheck="true">//        System.out.println(ping);</span>

        <span class="token comment" spellcheck="true">//添加</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//获取</span>
        String s <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//设置多个key - value</span>
        jedis<span class="token punctuation">.</span><span class="token function">mset</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span><span class="token string">"v1"</span><span class="token punctuation">,</span><span class="token string">"k2"</span><span class="token punctuation">,</span><span class="token string">"v2"</span><span class="token punctuation">,</span><span class="token string">"k3"</span><span class="token punctuation">,</span><span class="token string">"v3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        List<span class="token operator">&lt;</span>String<span class="token operator">></span> mget <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token string">"k1"</span><span class="token punctuation">,</span> <span class="token string">"k2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>mget<span class="token punctuation">)</span><span class="token punctuation">;</span>

        Set<span class="token operator">&lt;</span>String<span class="token operator">></span> keys <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>【注意：】</p>
<ul>
<li>查看配置文件 /etc/redis.conf <ul>
<li>注掉 bind = 127.0.0.1</li>
<li>把protected-mode yes  改为  protected-mode no</li>
</ul>
</li>
<li>关闭firewalld 和 iptables<ul>
<li>systemctl stop  firewalld </li>
<li>service iptables stop</li>
</ul>
</li>
</ul>
<h4 id="案例：模拟验证码发送"><a href="#案例：模拟验证码发送" class="headerlink" title="案例：模拟验证码发送"></a>案例：模拟验证码发送</h4><ul>
<li>输入手机号，点击发送后随机生成6位数字码，2分钟有效</li>
<li>输入验证码，点击验证，返回成功或失败</li>
<li>每个手机号每天只能输入3次</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210801185150.png"></p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * @author 王瀚文
 * @Description:
 * @date 2021-08-01 18:53
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PhoneCode</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 连接redis
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> Jedis jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.130.172"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">verifyCode</span><span class="token punctuation">(</span><span class="token string">"15110636286"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">getRedisCode</span><span class="token punctuation">(</span><span class="token string">"15110636286"</span><span class="token punctuation">,</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"VerifyCode15110636286:code"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">/**
     * 1.生成六位随机数
     *
     * @return 六位随机数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rand <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>rand<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 2.每个手机每天只能发送三次，验证码放到redis中，设置过期时间
     *
     * @param phone 手机号
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">verifyCode</span><span class="token punctuation">(</span>String phone<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//拼接手机发送次数的key</span>
        String countKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":count"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//拼接验证码的key</span>
        String codeKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":code"</span><span class="token punctuation">;</span>


        String s <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>countKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>countKey<span class="token punctuation">,</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">incr</span><span class="token punctuation">(</span>countKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"今天发送次数超过三次"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        String code <span class="token operator">=</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">setex</span><span class="token punctuation">(</span>codeKey<span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 3.验证码校验
     *
     * @param phone 手机号
     * @param code  验证码
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">getRedisCode</span><span class="token punctuation">(</span>String phone<span class="token punctuation">,</span> String code<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//拼接验证码的key</span>
        String codeKey <span class="token operator">=</span> <span class="token string">"VerifyCode"</span> <span class="token operator">+</span> phone <span class="token operator">+</span> <span class="token string">":code"</span><span class="token punctuation">;</span>

        String redisCode <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>codeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>redisCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="springboot整合redis"><a href="#springboot整合redis" class="headerlink" title="springboot整合redis"></a>springboot整合redis</h3><ul>
<li>导入依赖</li>
</ul>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.11.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<ul>
<li>配置文件</li>
</ul>
<pre class=" language-properties"><code class="language-properties"><span class="token comment" spellcheck="true">#Redis服务器地址</span>
<span class="token attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token attr-value">192.168.130.172</span>
<span class="token comment" spellcheck="true">#Redis服务器连接端D</span>
<span class="token attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token attr-value">6379</span>
<span class="token comment" spellcheck="true">#Redis数据库索引(默认为0)</span>
<span class="token attr-name">spring.redis.database</span><span class="token punctuation">=</span><span class="token attr-value">0</span>
<span class="token comment" spellcheck="true">#连接超时时间(毫秒)</span>
<span class="token attr-name">spring.redis.timeout</span><span class="token punctuation">=</span><span class="token attr-value">1800000s</span>
<span class="token comment" spellcheck="true">#连接池最大连接数(使用负值表示没有限制)</span>
<span class="token attr-name">spring.redis.lettuce.pool.max--active</span><span class="token punctuation">=</span><span class="token attr-value">20</span>
<span class="token comment" spellcheck="true">#最大阻塞等待时间(负数表示没限制)</span>
<span class="token attr-name">spring.redis.lettuce.pool.maxwait</span><span class="token punctuation">=</span><span class="token attr-value">-1s</span>
<span class="token comment" spellcheck="true">#连接池中的最大空闲连接</span>
<span class="token attr-name">spring.redis.lettuce.pool.max-idle</span><span class="token punctuation">=</span><span class="token attr-value">5</span>
<span class="token comment" spellcheck="true">#连接池中的最小空闲连接</span>
<span class="token attr-name">spring.redis.lettuce.pool.min-idle</span><span class="token punctuation">=</span><span class="token attr-value">0</span>
</code></pre>
<ul>
<li>配置类</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * @author 王瀚文
 * @Description:
 * @date 2021-08-01 22:09
 */</span>
<span class="token annotation punctuation">@EnableCaching</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> RedisTemplate<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span>RedisConnectionFactory factory<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      RedisTemplate<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      RedisSerializer<span class="token operator">&lt;</span>String<span class="token operator">></span> redisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Jackson2JsonRedisSerializer jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ObjectMapper om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>PropertyAccessor<span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> JsonAutoDetect<span class="token punctuation">.</span>Visibility<span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span>ObjectMapper<span class="token punctuation">.</span>DefaultTyping<span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
      template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
      template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> template<span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Bean</span>
   <span class="token keyword">public</span> CacheManager <span class="token function">cacheManager</span><span class="token punctuation">(</span>RedisConnectionFactory factory<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      RedisSerializer<span class="token operator">&lt;</span>String<span class="token operator">></span> redisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Jackson2JsonRedisSerializer jackson2JsonRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      ObjectMapper om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span>PropertyAccessor<span class="token punctuation">.</span>ALL<span class="token punctuation">,</span>JsonAutoDetect<span class="token punctuation">.</span>Visibility<span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span>ObjectMapper<span class="token punctuation">.</span>DefaultTyping<span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
      jackson2JsonRedisSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>
      RedisCacheConfiguration config <span class="token operator">=</span> RedisCacheConfiguration<span class="token punctuation">.</span><span class="token function">defaultCacheConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">entryTtl</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">serializeKeysWith</span><span class="token punctuation">(</span>RedisSerializationContext<span class="token punctuation">.</span>SerializationPair<span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>redisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">serializeValuesWith</span><span class="token punctuation">(</span>RedisSerializationContext<span class="token punctuation">.</span>SerializationPair<span class="token punctuation">.</span><span class="token function">fromSerializer</span><span class="token punctuation">(</span>jackson2JsonRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">disableCachingNullValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      RedisCacheManager cacheManager <span class="token operator">=</span> RedisCacheManager<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">cacheDefaults</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> cacheManager<span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<ul>
<li>controller层</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/redisTest"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTestController</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token annotation punctuation">@Autowired</span>
   <span class="token keyword">private</span> RedisTemplate<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>Object<span class="token operator">></span> redisTemplate<span class="token punctuation">;</span>

   <span class="token annotation punctuation">@GetMapping</span>
   <span class="token keyword">public</span> String <span class="token function">testRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//设置值到redis</span>
      redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span><span class="token string">"Tom"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//从redis获取值</span>
      String name <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> name<span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><h4 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h4><p>​    Redis事务是一个单独的隔离操作，事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请所打断。</p>
<p>​    Redis事务的==<strong>主要作用就是串联多个命令防止别的命令插队</strong>==。</p>
<p>【回忆MySQL事务：一个或一组sql语句组成的执行单元】</p>
<h4 id="Multi-–-Exec-–-discard"><a href="#Multi-–-Exec-–-discard" class="headerlink" title="Multi  –  Exec  –  discard"></a>Multi  –  Exec  –  discard</h4><p>从输入Multi 命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入Exec后，Redis会将之前的命令队列中的命令依次执行。组队的过程中可以通过discard来放弃组队。</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802072030.png"></p>
<h4 id="事务错误处理"><a href="#事务错误处理" class="headerlink" title="事务错误处理"></a>事务错误处理</h4><ul>
<li>组队中某个命令出现了报告错误，执行时整个队列都会被取消</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802072642.png"></p>
<ul>
<li>执行阶段某个命令报出了错误，则只有报错的命令不会被执行，其他的命令都会执行，<strong>不会回滚</strong>。</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802072808.png"></p>
<h4 id="事务冲突-悲观锁，乐观锁"><a href="#事务冲突-悲观锁，乐观锁" class="headerlink" title="事务冲突(悲观锁，乐观锁)"></a>事务冲突(悲观锁，乐观锁)</h4><p>悲观锁</p>
<p>​    悲观锁(Pessimistic Lock)，顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block 直到它拿到锁。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁，读锁，写锁等，都是在做操作之前先上锁。</p>
<p>乐观锁</p>
<p>​    乐观锁(Optimistic Lock),，顾名思义，就是很乐观 ，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号或者时间戳等机制。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。Redis 就是利用这种  check-and-set(CAS)  机制实现事务的。</p>
<p>【CAS是项乐观锁技术，当多个线程尝试使用CAS同时更新同一个变量时，只有其中一个线程能更新变量的值，而其它线程都失败，失败的线程并不会被挂起，而是被告知这次竞争中失败，并可以再次尝试。</p>
<p> CAS 操作包含三个操作数 —— 内存位置（V）、预期原值（A）和新值(B)。如果内存位置的值与预期原值相匹配，那么处理器会自动将该位置值更新为新值。否则，处理器不做任何操作。无论哪种情况，它都会在 CAS 指令之前返回该位置的值。（在 CAS 的一些特殊情况下将仅返回 CAS 是否成功，而不提取当前值。）CAS 有效地说明了“我认为位置 V 应该包含值 A；如果包含该值，则将 B 放到这个位置；否则，不要更改该位置，只告诉我这个位置现在的值即可。”这其实和乐观锁的冲突检查+数据更新的原理是一样的。==<strong>乐观锁是一种思想。CAS是这种思想的一种实现方式</strong>==。】</p>
<ul>
<li><p>WATCH key [key…]</p>
<ul>
<li>在执行multi之前，先执行watch key1 [key2]，可以监视一个(或多个) key ， 如果在事务执行之前这个(或这些) key被其他命令所改动,那么事务将被打断。</li>
</ul>
</li>
<li><p>unwatch</p>
<ul>
<li>取消对所有key的监视</li>
</ul>
</li>
</ul>
<h4 id="Redis事务三特性"><a href="#Redis事务三特性" class="headerlink" title="Redis事务三特性"></a>Redis事务三特性</h4><ul>
<li>单独的隔离操作<br>  事务中的所有命令 都会序列化、按顺序地执行。事务在执行的过程中, 不会被其他客户端发送来的命令求所打断。</li>
<li>没有隔离级别的概念 。<br>  队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行。</li>
<li>不保证原子性<br>事务中如果有一 条命令执行失败 ，其后的命令仍然会被执行，没有回滚。</li>
</ul>
<h4 id="Redis事务和MySQL的事务有什么区别"><a href="#Redis事务和MySQL的事务有什么区别" class="headerlink" title="Redis事务和MySQL的事务有什么区别"></a>Redis事务和MySQL的事务有什么区别</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/gjmhome/p/14409390.html">讲解1</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/264354517">讲解2</a></p>
<h4 id="秒杀案例"><a href="#秒杀案例" class="headerlink" title="秒杀案例"></a>秒杀案例</h4><pre class=" language-jsp"><code class="language-jsp"><%@ page language="java" contentType="text/html; charset=UTF-8"  pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Insert title here</title>
   </head>
   <body>
      <h1>iPhone 12 Pro !!!  1元秒杀！！！
      </h1>


      <form id="msform" action="$&#123;pageContext.request.contextPath&#125;/doseckill" enctype="application/x-www-form-urlencoded">
         <input type="hidden" id="prodid" name="prodid" value="0101">
         <input type="button"  id="miaosha_btn" name="seckill_btn" value="秒杀点我"/>
      </form>

   </body>
   <script  type="text/javascript" src="$&#123;pageContext.request.contextPath&#125;/script/jquery/jquery-3.1.0.js"></script>
   <script  type="text/javascript">
      $(function()&#123;
         $("#miaosha_btn").click(function()&#123;     
            var url=$("#msform").attr("action");
            $.post(url,$("#msform").serialize(),function(data)&#123;
               if(data=="false")&#123;
                  alert("抢光了" );
                  $("#miaosha_btn").attr("disabled",true);
               &#125;
            &#125; );    
         &#125;)
      &#125;)
   </script>
</html>
</code></pre>
<p>serlvet</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 秒杀案例
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKillServlet</span> <span class="token keyword">extends</span> <span class="token class-name">HttpServlet</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 1L<span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token function">SecKillServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doPost</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

      String userid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">""</span> <span class="token punctuation">;</span>
      String prodid <span class="token operator">=</span>request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"prodid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//        boolean isSuccess=SecKill_redis.doSecKill(userid,prodid);</span>
      <span class="token keyword">boolean</span> isSuccess<span class="token operator">=</span> SecKill_redisByScript<span class="token punctuation">.</span><span class="token function">doSecKill</span><span class="token punctuation">(</span>userid<span class="token punctuation">,</span>prodid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>isSuccess<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>Util</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JedisPoolUtil</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> JedisPool jedisPool <span class="token operator">=</span> null<span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token function">JedisPoolUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> JedisPool <span class="token function">getJedisPoolInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> jedisPool<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>JedisPoolUtil<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> jedisPool<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
               JedisPoolConfig poolConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPoolConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               poolConfig<span class="token punctuation">.</span><span class="token function">setMaxTotal</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               poolConfig<span class="token punctuation">.</span><span class="token function">setMaxIdle</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               poolConfig<span class="token punctuation">.</span><span class="token function">setMaxWaitMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               poolConfig<span class="token punctuation">.</span><span class="token function">setBlockWhenExhausted</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               poolConfig<span class="token punctuation">.</span><span class="token function">setTestOnBorrow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// ping  PONG</span>

               jedisPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisPool</span><span class="token punctuation">(</span>poolConfig<span class="token punctuation">,</span> <span class="token string">"192.168.130.172"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> <span class="token number">60000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
         <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> jedisPool<span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">release</span><span class="token punctuation">(</span>JedisPool jedisPool<span class="token punctuation">,</span> Jedis jedis<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> jedis<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         jedisPool<span class="token punctuation">.</span><span class="token function">returnResource</span><span class="token punctuation">(</span>jedis<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKill_redis</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        Jedis jedis <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.1.190"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//秒杀过程</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">doSecKill</span><span class="token punctuation">(</span>String uid<span class="token punctuation">,</span>String prodid<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//1 uid和prodid非空判断</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>uid <span class="token operator">==</span> null <span class="token operator">||</span> prodid <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//2 连接redis</span>
        <span class="token comment" spellcheck="true">//Jedis jedis = new Jedis("192.168.44.168",6379);</span>
        <span class="token comment" spellcheck="true">//通过连接池得到jedis对象</span>
        JedisPool jedisPoolInstance <span class="token operator">=</span> JedisPoolUtil<span class="token punctuation">.</span><span class="token function">getJedisPoolInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Jedis jedis <span class="token operator">=</span> jedisPoolInstance<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//3 拼接key</span>
        <span class="token comment" spellcheck="true">// 3.1 库存key</span>
        String kcKey <span class="token operator">=</span> <span class="token string">"sk:"</span><span class="token operator">+</span>prodid<span class="token operator">+</span><span class="token string">":qt"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 3.2 秒杀成功用户key</span>
        String userKey <span class="token operator">=</span> <span class="token string">"sk:"</span><span class="token operator">+</span>prodid<span class="token operator">+</span><span class="token string">":user"</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//监视库存</span>
        jedis<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>kcKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//4 获取库存，如果库存null，秒杀还没有开始</span>
        String kc <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>kcKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>kc <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"秒杀还没有开始，请等待"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 5 判断用户是否重复秒杀操作</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">sismember</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"已经秒杀成功了，不能重复秒杀"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//6 判断如果商品数量，库存数量小于1，秒杀结束</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>kc<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"秒杀已经结束了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//7 秒杀过程</span>
        <span class="token comment" spellcheck="true">//使用事务</span>
        Transaction multi <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//组队操作</span>
        multi<span class="token punctuation">.</span><span class="token function">decr</span><span class="token punctuation">(</span>kcKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        multi<span class="token punctuation">.</span><span class="token function">sadd</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//执行</span>
        List<span class="token operator">&lt;</span>Object<span class="token operator">></span> results <span class="token operator">=</span> multi<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>results <span class="token operator">==</span> null <span class="token operator">||</span> results<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"秒杀失败了...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//7.1 库存-1</span>
        <span class="token comment" spellcheck="true">//jedis.decr(kcKey);</span>
        <span class="token comment" spellcheck="true">//7.2 把秒杀成功用户添加清单里面</span>
        <span class="token comment" spellcheck="true">//jedis.sadd(userKey,uid);</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"秒杀成功了.."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>lua脚本，解决库存问题</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecKill_redisByScript</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span>  org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Logger logger <span class="token operator">=</span>LoggerFactory<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span>SecKill_redisByScript<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
      JedisPool jedispool <span class="token operator">=</span>  JedisPoolUtil<span class="token punctuation">.</span><span class="token function">getJedisPoolInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      Jedis jedis<span class="token operator">=</span>jedispool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      Set<span class="token operator">&lt;</span>HostAndPort<span class="token operator">></span> set<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>HostAndPort<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//    doSecKill("201","sk:0101");</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

   <span class="token keyword">static</span> String secKillScript <span class="token operator">=</span><span class="token string">"local userid=KEYS[1];\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"local prodid=KEYS[2];\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"local qtkey='sk:'..prodid..\":qt\";\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"local usersKey='sk:'..prodid..\":usr\";\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"local userExists=redis.call(\"sismember\",usersKey,userid);\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"if tonumber(userExists)==1 then \r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"   return 2;\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"end\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"local num= redis.call(\"get\" ,qtkey);\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"if tonumber(num)&lt;=0 then \r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"   return 0;\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"else \r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"   redis.call(\"decr\",qtkey);\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"   redis.call(\"sadd\",usersKey,userid);\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"end\r\n"</span> <span class="token operator">+</span> 
      <span class="token string">"return 1"</span> <span class="token punctuation">;</span>

   <span class="token keyword">static</span> String secKillScript2 <span class="token operator">=</span> 
      <span class="token string">"local userExists=redis.call(\"sismember\",\"&amp;#123;sk&amp;#125;:0101:usr\",userid);\r\n"</span> <span class="token operator">+</span>
      <span class="token string">" return 1"</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">doSecKill</span><span class="token punctuation">(</span>String uid<span class="token punctuation">,</span>String prodid<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

      JedisPool jedispool <span class="token operator">=</span>  JedisPoolUtil<span class="token punctuation">.</span><span class="token function">getJedisPoolInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Jedis jedis<span class="token operator">=</span>jedispool<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">//String sha1=  .secKillScript;</span>
      String sha1<span class="token operator">=</span>  jedis<span class="token punctuation">.</span><span class="token function">scriptLoad</span><span class="token punctuation">(</span>secKillScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Object result<span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">evalsha</span><span class="token punctuation">(</span>sha1<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> uid<span class="token punctuation">,</span>prodid<span class="token punctuation">)</span><span class="token punctuation">;</span>

      String reString<span class="token operator">=</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"0"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> reString <span class="token punctuation">)</span>  <span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"已抢空！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> reString <span class="token punctuation">)</span>  <span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"抢购成功！！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"2"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span> reString <span class="token punctuation">)</span>  <span class="token punctuation">)</span>  <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"该用户已抢过！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token keyword">else</span><span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"抢购异常！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
      jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<p>在linux中使用以下指令测试</p>
<p>​    ab -n 1000 -c 100   -p ~/postfile -T application/x-www-form-urlencoded<a target="_blank" rel="noopener" href="http://192.168.1.190:8080/seckill/doseckill">http://192.168.1.190:8080/seckill/doseckill</a></p>
<h3 id="持久化操作–-RDB"><a href="#持久化操作–-RDB" class="headerlink" title="持久化操作– RDB"></a>持久化操作– RDB</h3><h4 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h4><p>​    在指定的==<strong>时间间隔</strong>==内将内存中的数据集==<strong>快照</strong>==写入磁盘，也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里。</p>
<p>  备份的默认位置是  /usr/local/bin/dump.rdb，在 /etc/redis.conf 的 SNAPSHOTTING 下面可以修改</p>
<h4 id="备份原理"><a href="#备份原理" class="headerlink" title="备份原理"></a>备份原理</h4><p>​        Redis会单独创建( fork)一个子进程来进行持久化，<strong>会先将数据写入到一个临时文件中</strong>，待持久化过程都结束了，再用这个<strong>临时文件替换上次持久化好的文件</strong>（也称作写时复制）。整个过程中，主进程是不进行任何IO操作的,这就确保了极高的性能，如果需要进行大规模数据的恢复，对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。==<strong>RDB的缺点是最后一次持久化后的数据可能丢失</strong>==。</p>
<p>​    备份的过程是自动的，可以设置手动，但在手动备份的过程中会阻塞其他全部进程，等备份完了其他进程才会工作，所以不建议设置手动的</p>
<h4 id="Fork"><a href="#Fork" class="headerlink" title="Fork"></a>Fork</h4><ul>
<li><p>Fork的作用是复制一个与当前进程一样的进程。 新进程的所有数据(变量、环境变量、程序计数器等)数值都和原进程一致， 但是是一个全新的进程 ,并作为原进程的子进程</p>
</li>
<li><p>在Linux程序中, fork会产生一个和父进程完全相同的子进程 ，但子进程在此后多会被exec系统调用，出于效率考虑,，Linux中引入了”写时复制技术”。</p>
</li>
<li><p>一般情况父进程和子进程会共用同一段物理内存_,只有进程空间的各段的内容要发生变化时,才会将父进程的内容复制一份给子进程。</p>
</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802110201.png"></p>
<h4 id="rdb恢复备份"><a href="#rdb恢复备份" class="headerlink" title="rdb恢复备份"></a>rdb恢复备份</h4><p>关闭redis，重新启动redis时备份的 dump.rdb 文件会自动加载</p>
<h4 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h4><ul>
<li>适合大规模的数据恢复</li>
<li>对数据完整性和一致性要求不高时更适合使用</li>
<li>节省磁盘空间</li>
<li>恢复速度快</li>
<li>可以最大化redis性能</li>
</ul>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802111828.png"></p>
<h4 id="劣势"><a href="#劣势" class="headerlink" title="劣势"></a>劣势</h4><ul>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</li>
<li>虽然Redis在fork时使用了写时拷贝技术,但是如果数据庞大时还是比较消耗性能。</li>
<li>RDB是在备份周期中每间隔一段时间做一次备份，如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。</li>
</ul>
<h3 id="持久化操作-–-AOF"><a href="#持久化操作-–-AOF" class="headerlink" title="持久化操作 – AOF"></a>持久化操作 – AOF</h3><p> AOF(Append Only File)</p>
<h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>==<strong>以日志的形式来记录每个写操作(增量保存)</strong>== ，将Redis执行过的**所有写指令记录下来(读操作不记录)**，只许追加文件但不可以改写文件,，redis启动之初会读取该文件重新构建数据，换言之， redis重启的话就根据日志文件的内容将写指令从前到后执行一次，以完成数据的恢复工作。</p>
<p><strong>AOF默认不开启：</strong>在 /etc/redis.conf 中把  appendonly  no    改为 appendonly  yes</p>
<p>可以在 redis.conf 中配置文件名称，默认为appendonly.aof。AOF文件的保存路径与RDB的路径一致。</p>
<h4 id="AOF持久化流程"><a href="#AOF持久化流程" class="headerlink" title="AOF持久化流程"></a>AOF持久化流程</h4><ul>
<li><p>客户端的请求写命令会被append追加到AOF缓冲区内。</p>
</li>
<li><p>AOF缓冲区根据AOF同步频率的设置 [always，everysec，no]  将操作sync写到磁盘的AOF文件中。</p>
</li>
<li><p>AOF文件大小超过重写策略或手动重写时，会对AOF文件  rewrite 重写，压缩 AOF文件容量。</p>
</li>
<li><p>Redis服务重启时，会重新 load 加载  AOF 文件中的写操作以达道数据恢复的目的。</p>
</li>
</ul>
<h4 id="正常恢复"><a href="#正常恢复" class="headerlink" title="正常恢复"></a>正常恢复</h4><p>重启redis服务，数据重新加载</p>
<h4 id="异常恢复"><a href="#异常恢复" class="headerlink" title="异常恢复"></a>异常恢复</h4><p>appendonly.aof损坏  后重启redis  报错 ：Could not connect to Redis at 127.0.0.1:6379: Connection refused</p>
<p>步骤：</p>
<ul>
<li><p>cd  /usr/local/bin</p>
</li>
<li><p>redis-check-aof –fix appendonly.aof    </p>
</li>
<li><p>重启redis</p>
</li>
</ul>
<h4 id="AOF同步频率设置"><a href="#AOF同步频率设置" class="headerlink" title="AOF同步频率设置"></a>AOF同步频率设置</h4><ul>
<li>appendfsync always<ul>
<li>始终同步，每次redis的写入都会立刻计入日志，性能较差但数据完整性比较好</li>
</ul>
</li>
<li>appendfsync everysec<ul>
<li>每秒同步，每次记录日志一次，如果宕机，本秒的数据可能丢失</li>
</ul>
</li>
<li>appendfsync no<ul>
<li>redis不主动进行同步，把同步时机交给操作系统</li>
</ul>
</li>
</ul>
<h4 id="Rewirte压缩"><a href="#Rewirte压缩" class="headerlink" title="Rewirte压缩"></a>Rewirte压缩</h4><p>重写压缩操作</p>
<p>概念：</p>
<p>​    AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制，当AOF文件的大小超过所设定的阈值时, Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令bgrewriteaof。</p>
<p>原理：</p>
<p>​    AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename) , redis4.0版本后的重写，实质上就是把rdb的快照，以二进制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。</p>
<p><strong>大于128M才会重写</strong></p>
<p>重写流程</p>
<ul>
<li>bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。</li>
<li>主进程fork出子进程执行写操作，保证主进程不会阻塞。</li>
<li>子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入aof_ buf缓冲区和aof_ rewrite_ buf 重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。</li>
<li>子进程写完新的AOF文件后,向主进程发信号,父进程更新统计信息。</li>
<li>主进程把aof_ rewrite_ _buf 中的数据写入到新的AOF文件。</li>
<li>使用新的AOF文件覆盖旧的AOF文件,完成AOF重写。。</li>
</ul>
<h4 id="优势-1"><a href="#优势-1" class="headerlink" title="优势"></a>优势</h4><ul>
<li>备份机制追加文件，丢失数据概率更低</li>
<li>可读的日志文本，通过操作APO 文件，可以处理误操作。</li>
</ul>
<h4 id="劣势-1"><a href="#劣势-1" class="headerlink" title="劣势"></a>劣势</h4><ul>
<li>比起RDB占用更多的磁盘空间</li>
<li>恢复备份速度要慢</li>
<li>每次读写都同步的话，有一定的性能压力</li>
<li>存在个别Bug，造成不能恢复</li>
</ul>
<p>==<strong>如果  RDB  和 AOF 同时开启，系统默认去加载 AOF的数据</strong>==</p>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>==<strong>一主多从</strong>==</p>
<h4 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h4><p>​    主机数据更新后根据配置和策略，主动同步到备用机的 master/slaver机制，Master以写为主,，Slave以读为主。</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802130815.png"></p>
<h4 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h4><ul>
<li>读写分离，性能扩展</li>
<li>容灾快速恢复</li>
</ul>
<h4 id="搭建一主多从"><a href="#搭建一主多从" class="headerlink" title="搭建一主多从"></a>搭建一主多从</h4><ul>
<li><p>创建 /myredis  文件夹</p>
</li>
<li><p>复制redis.conf  配置文件到  /myredis</p>
</li>
<li><p>创建一主两从，创建三个配置文件</p>
<ul>
<li>redis6379.conf</li>
<li>redis6380.conf</li>
<li>redis6381.conf</li>
</ul>
</li>
<li><p>在配置文件中写入内容</p>
</li>
</ul>
<pre class=" language-java"><code class="language-java">include <span class="token operator">/</span>myredis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
pidfile <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>redis_6379<span class="token punctuation">.</span>pid
port <span class="token number">6379</span>
dbfilename dump6379<span class="token punctuation">.</span>rdb   
   
include <span class="token operator">/</span>myredis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
pidfile <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>redis_6380<span class="token punctuation">.</span>pid
port <span class="token number">6380</span>
dbfilename dump6380<span class="token punctuation">.</span>rdb
   
include <span class="token operator">/</span>myredis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
pidfile <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>redis_6381<span class="token punctuation">.</span>pid
port <span class="token number">6381</span>
dbfilename dump6381<span class="token punctuation">.</span>rdb
</code></pre>
<ul>
<li>启动三个redis服务<ul>
<li>进入所要查看的redis客户端</li>
<li>输入   info replication   查看当前的运行状况</li>
</ul>
</li>
</ul>
<ul>
<li>配从不配主<ul>
<li>在从机上    slaveof   &lt;ip&gt;   &lt;port&gt;</li>
</ul>
</li>
</ul>
<ul>
<li><p>至此实现了 6379  为主 ，6380 和6381 为从 的一主多从</p>
</li>
<li><p>在主机上写，从机可以读取到，但是在从机上写，就会报错</p>
<p>(error) READONLY You can’t write against a read only replica.</p>
</li>
</ul>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><ul>
<li>当从机接上主服务之后，从服务器向主服务发送数据同步消息</li>
<li>主服务器接到从服务器发送过来请求同步的消息，把主服务器数据进行持久化，rdb文件，把rdb文件发送从服务器，从服务器拿到rdb进行读取（全量复制）</li>
<li>之后每次主服务器进行写出操作后，会<strong>主动</strong>和从服务器进行数据同步（增量复制）</li>
</ul>
<h4 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h4><ul>
<li>一主二仆：  <strong>一个主机多个从机</strong><ul>
<li>从机挂掉后重启之后会成为一个新的主机，不会和原来的主机关联</li>
<li>重新成为从机之后，会把主机所有数据都复制过来</li>
<li>主服务器挂掉后，从服务器还是会连着挂掉的主服务器</li>
<li>主服务器重启之后还是主服务器，连接着原来的从服务器</li>
</ul>
</li>
</ul>
<ul>
<li>薪火相传：<strong>一个主机一个从机，从机之后还有从机</strong><ul>
<li>特点和一主二仆一样</li>
</ul>
</li>
</ul>
<ul>
<li>反客为主：主的挂掉，从机上位<ul>
<li>主机挂掉后，从机输入   slaveof  no one ，从机成为主机</li>
<li>原主机的从机都成为了 上位的这个从机  的从机</li>
<li>如果原主机复活，则原主机会成为  新主机的从机</li>
<li>这个得手动设置，如果想自动设置，需要==<strong>哨兵模式</strong>==</li>
</ul>
</li>
</ul>
<h4 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h4><p>==<strong>反客为主的自动版</strong>==，能够后台监控主机是否故障，如果故障了根据<strong>投票数</strong>自动将从机转为主机</p>
<ul>
<li>cd   /myredis</li>
<li>vim sentinel.conf</li>
<li>添加：  sentinel monitor mymaster 192.168.130.172 6379  1</li>
</ul>
<p>mymaster 是为监控对象起的服务器名称，1 代表至少有一个哨兵同意迁移</p>
<ul>
<li>redis-sentinel  /myredis/sentinel.conf</li>
<li>设置哨兵成功</li>
</ul>
<p>哨兵模式涉及到选取哪个从机当主机的问题，选择的条件依次为：</p>
<ul>
<li>replica-priority 100，值越小优先级越高，优先级在redis.conf中默认 为100</li>
<li>偏移量大的优先，偏移量是指获得原主机数据最全的</li>
<li>选择 runid 最小的，每个redis实例启动后都会随机生成一个40位的 runid</li>
</ul>
<p>【投票】<strong>（半数原则）</strong></p>
<p>​    当任何一个Sentinel发现被监控的Master下线时，会通知其它的Sentinel开会，投票确定该Master是否下线（半数以上，所以sentinel<strong>通常配奇数个</strong>）。</p>
<h4 id="复制延时"><a href="#复制延时" class="headerlink" title="复制延时"></a>复制延时</h4><p>​    由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟 ，当系统很繁忙的时候，延迟问题会更加严重,，Slave机器数量的增加也会使这个问题更加严重。</p>
<h3 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h3><p>问题：我们已经部署好了redis，并且能启动一个redis，实现数据的读写，为什么还要学习redis集群？</p>
<p>（1）单个redis存在不稳定性。当redis服务宕机了，就没有可用的服务了。</p>
<p>（2）单个redis的读写能力是有限的。</p>
<p><strong>总结：redis集群是为了强化redis的读写能力</strong></p>
<h4 id="什么是集群"><a href="#什么是集群" class="headerlink" title="什么是集群"></a>什么是集群</h4><p>​    Redis集群实现了对Redis的水平扩容，即启动N个redis节点(节点只能是Master)，将整个数据库分布存储在这N个节点中，每个节点存储总数据1/N。<br>​    Redis集群通过分区( partition )来提供一定程度的可用性 ( availability ) ：即使集群中有一部分节点失效或者无法进行通讯，集群也可以继续处理命令请求。</p>
<p>任何一个节点都可以作为集群的入口</p>
<h4 id="搭建reids集群"><a href="#搭建reids集群" class="headerlink" title="搭建reids集群"></a>搭建reids集群</h4><ul>
<li><p>删除  .rdb 和  .aof 文件</p>
</li>
<li><p>制作6个实例，6379，6380，6381，6389，6390，6391</p>
</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//其他几个除了端口号需要改为自己的，其他的都不要动</span>
include <span class="token operator">/</span>myredis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
pidfile <span class="token operator">/</span>var<span class="token operator">/</span>run<span class="token operator">/</span>redis_6379<span class="token punctuation">.</span>pid
port <span class="token number">6379</span>
dbfilename dump6379<span class="token punctuation">.</span>rdb  
cluster<span class="token operator">-</span>enabled yes <span class="token comment" spellcheck="true">//开启集群</span>
cluster<span class="token operator">-</span>config<span class="token operator">-</span>file nodes<span class="token operator">-</span><span class="token number">6379</span><span class="token punctuation">.</span>conf <span class="token comment" spellcheck="true">//设置节点的配置文件名称</span>
cluster<span class="token operator">-</span>node<span class="token operator">-</span>timeout <span class="token number">15000</span>  <span class="token comment" spellcheck="true">//设置节点失联时间，超过该时间(毫秒)，集群自动进行主从切换</span>
【补充：<span class="token string">":%s/6379/6380"</span> 可以把<span class="token number">6379</span>全局替换为<span class="token number">6380</span>，  <span class="token string">"::set nu"</span> 是显示行号】
</code></pre>
<ul>
<li><p>启动6个redis</p>
</li>
<li><p>cd /opt/redis-6.2.5/src</p>
</li>
<li><p>redis-cli    –cluster   create    –cluster-replicas   1   192.168.130.172:6379    192.168.130.172:6380    192.168.130.172:6381    192.168.130.172:6389     192.168.130.172:6390     192.168.130.172:6391  </p>
</li>
</ul>
<p>【这里必须得用真实IP地址 ， 这里的 1 代表采用最简单的方式配置集群，一台主机，一台从机，正好三组】</p>
<ul>
<li><p>redis-cli -c -p 6379或者6380或者6381     只要是主机都可以连接到集群，设置数据会==<strong>自动切换</strong>==到相应的写主机。</p>
</li>
<li><p>cluster nodes      可以查看集群信息</p>
</li>
</ul>
<h4 id="集群的结点分配"><a href="#集群的结点分配" class="headerlink" title="集群的结点分配"></a>集群的结点分配</h4><p>==<strong>一个集群至少有三个主节点</strong>==</p>
<p>​    分配原则尽量保证每个主数据库运行在不同的IP地址，每个从库不在一个IP地址上，这也就是为什么上面说的必须用真实的IP的原因。</p>
<h4 id="Slots"><a href="#Slots" class="headerlink" title="Slots"></a>Slots</h4><p>​    一个Redis集群包含 16384个  插槽（hash  slot），数据库中的每一个键都属于这 16384个插槽的一个。</p>
<p>​    集群使用公式==**CRC16(key) % 16384 **==来计算key属于哪个槽。</p>
<p>​    集群中每个节点都负责一部分插槽</p>
<p>​    上述集群的插槽分部情况</p>
<p><img src="/images/QQ%E6%88%AA%E5%9B%BE20210802164752.png"></p>
<h4 id="集群中插入值"><a href="#集群中插入值" class="headerlink" title="集群中插入值"></a>集群中插入值</h4><p>​    在redis-cli每次录入、查询键值， redis都会计算出该key应该送往的插槽，如果不是该客户端对应服务器的插槽,，redis 会报错，告知应前往的redis实例地址和端口。redis-cli户端提供了  - c   参数实现自动重定向。<br> 比如<strong>redis-cli -C- p 6379 登入后,再录入、查询键值对可以自动重定向</strong>。</p>
<p>通过{}来定义组的概念，从而是key中{}内相同的内容的键值对昂达哦一个slot中去</p>
<pre class=" language-redis"><code class="language-redis">mset  name&#123;user&#125; Tom   age&#123;user&#125;  20
</code></pre>
<h4 id="查询集群中的值"><a href="#查询集群中的值" class="headerlink" title="查询集群中的值"></a>查询集群中的值</h4><ul>
<li>cluser keyslot &lt;key&gt;   <ul>
<li>计算 key 对应的插槽</li>
</ul>
</li>
<li>cluster countkeysinslot  插槽值<ul>
<li>返回该插槽中有几个key，只能在插槽对应的redis下操作</li>
</ul>
</li>
</ul>
<h4 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h4><p>如果主机下线，从机会替换主机成为新主机，主机上线之后成为新主机的从机</p>
<p>如果某一段插槽的主从都挂掉，并且  cluster-require-full-coverage 为</p>
<ul>
<li> yes，那么整个集群都挂掉</li>
<li>  no ，则只是该插槽的数据不能用和无法存储</li>
</ul>
<h4 id="集群的jedis开发"><a href="#集群的jedis开发" class="headerlink" title="集群的jedis开发"></a>集群的jedis开发</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisClusterDemo</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

      HostAndPort hostAndPort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostAndPort</span><span class="token punctuation">(</span><span class="token string">"192.168.130.172"</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      JedisCluster jedisCluster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JedisCluster</span><span class="token punctuation">(</span>hostAndPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

      String set <span class="token operator">=</span> jedisCluster<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"b1"</span><span class="token punctuation">,</span> <span class="token string">"value1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"value:"</span> <span class="token operator">+</span> set<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         jedisCluster<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
   <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="Redis集群的不足"><a href="#Redis集群的不足" class="headerlink" title="Redis集群的不足"></a>Redis集群的不足</h4><ul>
<li>多键操作不被支持，需要其他方法实现</li>
<li>多键的Redis事务是不被支持的，lua脚本不被支持</li>
<li>由于Redis集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至redis cluster ,需要整体迁移而不是逐步过渡,复杂度较大。</li>
</ul>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><h4 id="概念-3"><a href="#概念-3" class="headerlink" title="概念"></a>概念</h4><p> 缓存穿透是指缓存和数据库中都没有的数据，而用户不断的发起请求。</p>
<p>key对应的数据在数据源并不存在，每次针对此key的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据源。比如用一个不存在的用户id 获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击可能压垮数据库。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li><p>对空值缓存</p>
<p>​     如果一个查询返回的数据为空(不管是数据是否不存在)，我们仍然把这个空结果( null )进行缓存，设置空结果的过期时间会很短，最长不超过五分钟。</p>
</li>
<li><p>设置可访问的名单(白名单)</p>
<p>   使用bitmaps类型定义一个可以访问的名单 ，名单id作为bitmaps的偏移量，每次访问和bitmap里面的id进行比较，如果访问id不在bitmaps里面，进行拦截,不允许访问。</p>
</li>
<li><p>采用布隆过滤器</p>
<p>​    布隆过滤器( Bloom Filter )是1970 年由布隆提出的。它实际上是一个很长的二进制向量(位图)和一系列随机映射函数(哈希函数)。布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。将所有可能存在的数据哈希到一个足够大的bitmaps 中，一个一定不存在的数据会被这个bitmaps拦截掉，从而避免了对底层存储系统的查询压力。</p>
</li>
<li><p>进行实时监控</p>
<p>   当发现Redis的命中率开始急速降低，需要排查访问对象和访问的数据，和运维人员配合，可以设置黑名单限制服务。</p>
</li>
</ul>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>​    缓存击穿是指一条数据缓存中没有但数据库中有的数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没读到数据，又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li>预先设置热门数据：在redis高峰访问之前，把一些热门数据提前存到redis里面，加大这些热门数据的key的时长，或者设置为永不过时</li>
<li>实时调整：现场监控哪些数据热门，实时调整key的过期时长</li>
<li>使用锁</li>
</ul>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><h4 id="描述："><a href="#描述：" class="headerlink" title="描述："></a>描述：</h4><p>   缓存雪崩是指缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。和缓存击穿不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。</p>
<h4 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li><p>构建多级缓存架构：Nginx缓存 +  redis 缓存  +  其他缓存（ehcache）</p>
</li>
<li><p>使用锁或队列：</p>
<p>​     用加锁或者队列的方式来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。但是不适用高并发情况。</p>
</li>
<li><p>设置过期标志更新缓存<br>   记录缓存数据是否过期(设置提前量) ,如果过期会触发通知另外的线程在后台去更新实际key的缓存。</p>
</li>
<li><p>将缓存失效时间分散开</p>
<pre><code>  比如我们可以在原有的失效时间基础上增加一个随机值,比如1-5 分钟的随机值，这样每-一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。
</code></pre>
</li>
</ul>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><h4 id="描述-1"><a href="#描述-1" class="headerlink" title="描述"></a>描述</h4><p>​    随着业务发展的需要，原单体单机部署的系统被演化成分布式集群系统后，由于分布式系统的多进程和多线程，并且分布在不同机器上，这将使原单机部署情况下的并发控制锁策略失效，单纯的Java API并不能提供分布式锁的能力。为了解决这个问题就需要一种跨 JVM的互斥机制来控制共享资源的访问,这就是分布式锁要解决的问题!。</p>
<ul>
<li><p>基于数据类实现分布式锁</p>
</li>
<li><p>基于缓存，redis等</p>
</li>
<li><p>基于Zookeeper</p>
</li>
</ul>
<p>每一种分布式锁解决方案都有各自的优缺点</p>
<ul>
<li>性能：redis最高</li>
<li>可靠性：zookeeper最高</li>
</ul>
<h4 id="使用redis实现分布式锁"><a href="#使用redis实现分布式锁" class="headerlink" title="使用redis实现分布式锁"></a>使用redis实现分布式锁</h4><ul>
<li><p>使用 setnx 上锁，通过  del 释放锁</p>
</li>
<li><p>如果锁一直没有释放，设置key过期时间，自动释放</p>
</li>
<li><p>如果上锁之后突然出现异常，无法设置过期时间了，只需在上锁的同时设置过期时间就可以</p>
<ul>
<li>set  &lt;key&gt;  &lt;value&gt;  nx   ex   时长</li>
</ul>
</li>
</ul>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>​    Redis ACL是Access Control List (访问控制列表)的缩写，该功能允许根据可以执行的命令和可以访问的键来限制某些连接。   </p>
<p>​    在Redis 5版本之前, Redis安全规则只有密码控制还有通过rename来调整高危命令比如flushdb ，KEYS *， shutdown 等。    </p>
<p> Redis 6则提供ACL的功能对用户进行更细粒度的权限控制：</p>
<ul>
<li>接入权限，用户名和密码</li>
<li>可以执行的命令</li>
<li>可以操作的KEY</li>
</ul>
<p>常用指令</p>
<ul>
<li><p>acl list  </p>
<ul>
<li>命令展示用户权限列表</li>
</ul>
</li>
<li><p>acl  set setuser &lt;username&gt;</p>
<ul>
<li>添加用户</li>
</ul>
</li>
<li><p>alc  whoami</p>
<ul>
<li>查看当前用户是谁</li>
</ul>
</li>
<li><p>acl   setuser    &lt;username&gt;   on   &gt;密码    ~cache:*   +get </p>
<ul>
<li>key前面加 cache：    并且只能对get操作</li>
</ul>
</li>
<li><p>auth    &lt;username&gt;     &lt;password&gt;</p>
<ul>
<li>切换用户</li>
</ul>
</li>
</ul>
<h1 id="跳跃表（跳表）"><a href="#跳跃表（跳表）" class="headerlink" title="跳跃表（跳表）"></a>跳跃表（跳表）</h1><h2 id="1-跳跃表的原理"><a href="#1-跳跃表的原理" class="headerlink" title="1. 跳跃表的原理"></a>1. 跳跃表的原理</h2><p>   学过数据结构的都知道，在单链表中查询一个元素的时间复杂度为O(n)，即使该单链表是有序的，我们也不能通过2分的方式缩减时间复杂度。 </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163550.png" alt="img"></p>
<p>   如上图，我们要查询元素为55的结点，必须从头结点，循环遍历到最后一个节点，不算-INF(负无穷)一共查询8次。那么用什么办法能够用更少的次数访问55呢？最直观的，当然是新开辟一条捷径去访问55。 </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163558.png"></p>
<p>   如上图，我们要查询元素为55的结点，只需要在L2层查找4次即可。在这个结构中，查询结点为46的元素将耗费最多的查询次数5次。即先在L2查询46，查询4次后找到元素55，因为链表是有序的，46一定在55的左边，所以L2层没有元素46。然后我们退回到元素37，到它的下一层即L1层继续搜索46。非常幸运，我们只需要再查询1次就能找到46。这样一共耗费5次查询。</p>
<p>那么，如何才能更快的搜寻55呢？有了上面的经验，我们就很容易想到，再开辟一条捷径。 </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163637.png" alt="这里写图片描述"></p>
<p>   如上图，我们搜索55只需要2次查找即可。这个结构中，查询元素46仍然是最耗时的，需要查询5次。即首先在L3层查找2次，然后在L2层查找2次，最后在L1层查找1次，共5次。很显然，这种思想和2分非常相似，那么我们最后的结构图就应该如下图。</p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163651.png"></p>
<p>​    我们可以看到，最耗时的访问46需要6次查询。即L4访问55，L3访问21、55，L2访问37、55，L1访问46。我们直觉上认为，这样的结构会让查询有序链表的某个元素更快。那么究竟算法复杂度是多少呢？</p>
<p>​    如果有n个元素，因为是2分，所以层数就应该是log n层 (本文所有log都是以2为底)，再加上自身的1层。以上图为例，如果是4个元素，那么分层为L3和L4，再加上本身的L2，一共3层；如果是8个元素，那么就是3+1层。最耗时间的查询自然是访问所有层数，耗时logn+logn，即2logn。为什么是2倍的logn呢？我们以上图中的46为例，查询到46要访问所有的分层，每个分层都要访问2个元素，中间元素和最后一个元素。所以时间复杂度为O(logn)。</p>
<p>​    至此为止，我们引入了最理想的跳跃表，但是如果想要在上图中插入或者删除一个元素呢？比如我们要插入一个元素22、23、24……，自然在L1层，我们将这些元素插入在元素21后，那么L2层，L3层呢？我们是不是要考虑插入后怎样调整连接，才能维持这个理想的跳跃表结构。我们知道，平衡二叉树的调整是一件令人头痛的事情，左旋右旋左右旋……一般人还真记不住，而调整一个理想的跳跃表将是一个比调整平衡二叉树还复杂的操作。幸运的是，我们并不需要通过复杂的操作调整连接来维护这样完美的跳跃表。有一种基于概率统计的插入算法，也能得到时间复杂度为O(logn)的查询效率，这种跳跃表才是我们真正要实现的。</p>
<h2 id="2-跳跃表的实现步骤分析"><a href="#2-跳跃表的实现步骤分析" class="headerlink" title="2. 跳跃表的实现步骤分析"></a>2. 跳跃表的实现步骤分析</h2><p>​    先讨论插入，我们先看理想的跳跃表结构，L2层的元素个数是L1层元素个数的1/2，L3层的元素个数是L2层的元素个数的1/2，以此类推。从这里，我们可以想到，只要在插入时尽量保证上一层的元素个数是下一层元素的1/2，我们的跳跃表就能成为理想的跳跃表。那么怎么样才能在插入时保证上一层元素个数是下一层元素个数的1/2呢？很简单，抛硬币就能解决了！假设元素X要插入跳跃表，很显然，L1层肯定要插入X。那么L2层要不要插入X呢？我们希望上层元素个数是下层元素个数的1/2，所以我们有1/2的概率希望X插入L2层，那么抛一下硬币吧，正面就插入，反面就不插入。那么L3到底要不要插入X呢？相对于L2层，我们还是希望1/2的概率插入，那么继续抛硬币吧！以此类推，元素X插入第n层的概率是(1/2)的n次。这样，我们能在跳跃表中插入一个元素了。</p>
<p>在此还是以上图为例：跳跃表的初试状态如下图，表中没有一个元素： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163702.png" alt="这里写图片描述"></p>
<p>如果我们要插入元素2，首先是在底部插入元素2，如下图： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163715.png" alt="这里写图片描述"></p>
<p>然后我们抛硬币，结果是正面，那么我们要将2插入到L2层，如下图: </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163807.png"></p>
<p>继续抛硬币，结果是反面，那么元素2的插入操作就停止了，插入后的表结构就是上图所示。接下来，我们插入元素33，跟元素2的插入一样，现在L1层插入33，如下图： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163735.png" alt="这里写图片描述"></p>
<p>然后抛硬币，结果是反面，那么元素33的插入操作就结束了，插入后的表结构就是上图所示。接下来，我们插入元素55，首先在L1插入55，插入后如下图： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163830.png" alt="这里写图片描述"></p>
<p>然后抛硬币，结果是正面，那么L2层需要插入55，如下图： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163845.png" alt="这里写图片描述"></p>
<p>继续随机，结果又是正面，那么L3层需要插入55，如下图： </p>
<p><img src="images/QQ%E6%88%AA%E5%9B%BE20210811163854.png" alt="这里写图片描述"></p>
<p>​    以此类推，我们插入剩余的元素。当然因为规模小，结果很可能不是一个理想的跳跃表。但是如果元素个数n的规模很大，学过概率论的同学都知道，最终的表结构肯定非常接近于理想跳跃表。</p>
<p>​    当然，这样的分析在感性上是很直接的，但是时间复杂度的证明实在复杂，在此我就不深究了，感兴趣的可以去看关于跳跃表的paper。再讨论删除，删除操作没什么讲的，直接删除元素，然后调整一下删除元素后的指针即可。跟普通的链表删除操作完全一样。再来讨论一下时间复杂度，插入和删除的时间复杂度就是查询元素插入位置的时间复杂度，这不难理解，所以是O(logn)。</p>
<h2 id="3-代码实现"><a href="#3-代码实现" class="headerlink" title="3. 代码实现"></a>3. 代码实现</h2><p>在章节2中，我们采用抛硬币的方式来决定新元素插入的最高层数，这当然不能在程序中实现。代码中，我们采用随机数生成的方式来获取新元素插入的最高层数。我们先估摸一下n的规模，然后定义跳跃表的最大层数maxLevel，那么底层，也就是第0层，元素是一定要插入的，概率为1；最高层，也就是maxLevel层，元素插入的概率为1/2^maxLevel。</p>
<p>我们先随机生成一个范围为0~2^maxLevel-1  的一个整数r。那么元素r小于2^(maxLevel-1) 的概率为1/2，r小于2^(maxLevel-2) 的概率为1/4，……，r小于2的概率为1/2^(maxLevel-1) ，r小于1的概率为1/2^maxLevel。</p>
<p>举例，假设maxLevel为4，那么r的范围为0~15，则r小于8的概率为1/2，r小于4的概率为1/4，r小于2的概率为1/8，r小于1的概率为1/16。1/16正好是maxLevel层插入元素的概率，1/8正好是maxLevel层插入的概率，以此类推。</p>
<p>通过这样的分析，我们可以先比较r和1，如果r&lt;1，那么元素就要插入到maxLevel层以下；否则再比较r和2，如果r&lt;2，那么元素就要插入到maxLevel-1层以下；再比较r和4，如果r&lt;4，那么元素就要插入到maxLevel-2层以下……如果r&gt;2^(maxLevel - 1)，那么元素就只要插入在底层即可。</p>
<p>以上分析是随机数算法的关键。算法跟实现跟语言无关，但是Java程序员还是更容易看明白Java代码实现的跳跃表</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/***************************  SkipList.java  *********************/</span>
 
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkipList</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Comparable</span><span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">>></span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxLevel<span class="token punctuation">;</span>
    <span class="token keyword">private</span> SkipListNode<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> root<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> powers<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Random rd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SkipList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token function">SkipList</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        maxLevel <span class="token operator">=</span> i<span class="token punctuation">;</span>
        root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipListNode</span><span class="token punctuation">[</span>maxLevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
        powers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>maxLevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> maxLevel<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
            root<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token function">choosePowers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> root<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">choosePowers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        powers<span class="token punctuation">[</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 2^maxLevel - 1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> maxLevel <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">,</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
           powers<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> powers<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">&lt;&lt;</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 2^(j+1)</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">chooseLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i<span class="token punctuation">,</span> r <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> powers<span class="token punctuation">[</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxLevel<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> powers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// return a level &lt; the highest level;</span>
        <span class="token keyword">return</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// return the highest level;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// make sure (with isEmpty()) that search() is called for a nonempty list;</span>
    <span class="token keyword">public</span> T <span class="token function">search</span><span class="token punctuation">(</span>T key<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> 
        <span class="token keyword">int</span> lvl<span class="token punctuation">;</span>
        SkipListNode<span class="token operator">&lt;</span>T<span class="token operator">></span> prev<span class="token punctuation">,</span> curr<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// find the highest nonnull</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>lvl <span class="token operator">=</span> maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> lvl <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> root<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">;</span> lvl<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// level;</span>
        prev <span class="token operator">=</span> curr <span class="token operator">=</span> root<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment" spellcheck="true">// success if equal;</span>
                 <span class="token keyword">return</span> curr<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>curr<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// if smaller, go down,</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>lvl <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                 <span class="token comment" spellcheck="true">// if possible</span>
                      <span class="token keyword">return</span> null<span class="token punctuation">;</span>      
                 <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> root<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// by one level</span>
                      curr <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token operator">--</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// starting from the</span>
                 <span class="token keyword">else</span> curr <span class="token operator">=</span> prev<span class="token punctuation">.</span>next<span class="token punctuation">[</span><span class="token operator">--</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// predecessor which</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>                                  <span class="token comment" spellcheck="true">// can be the root;</span>
            <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                             <span class="token comment" spellcheck="true">// if greater,</span>
                 prev <span class="token operator">=</span> curr<span class="token punctuation">;</span>                  <span class="token comment" spellcheck="true">// go to the next</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">// non-null node</span>
                      curr <span class="token operator">=</span> curr<span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// on the same level</span>
                 <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// or to a list on a lower level;</span>
                      <span class="token keyword">for</span> <span class="token punctuation">(</span>lvl<span class="token operator">--</span><span class="token punctuation">;</span> lvl <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> curr<span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">;</span> lvl<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>lvl <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                           curr <span class="token operator">=</span> curr<span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>
                      <span class="token keyword">else</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                 <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>T key<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        SkipListNode<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> curr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipListNode</span><span class="token punctuation">[</span>maxLevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
        SkipListNode<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> prev <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipListNode</span><span class="token punctuation">[</span>maxLevel<span class="token punctuation">]</span><span class="token punctuation">;</span>
        SkipListNode<span class="token operator">&lt;</span>T<span class="token operator">></span> newNode<span class="token punctuation">;</span>
        <span class="token keyword">int</span> lvl<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
        curr<span class="token punctuation">[</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">[</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        prev<span class="token punctuation">[</span>maxLevel<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>lvl <span class="token operator">=</span> maxLevel <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> lvl <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> lvl<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> 
                prev<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">=</span> curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// go to the next</span>
                curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">=</span> curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// if smaller;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>curr<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// don't </span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>                          <span class="token comment" spellcheck="true">// include duplicates;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lvl <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>                         <span class="token comment" spellcheck="true">// go one level down</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// if not the lowest</span>
                      curr<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> root<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// level, using a link</span>
                      prev<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// either from the root</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>                           <span class="token comment" spellcheck="true">// or from the predecessor;</span>
                     curr<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> prev<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                     prev<span class="token punctuation">[</span>lvl<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> prev<span class="token punctuation">[</span>lvl<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        lvl <span class="token operator">=</span> <span class="token function">chooseLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// generate randomly level </span>
        newNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipListNode</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>lvl<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// for newNode;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> lvl<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// initialize next fields of</span>
            newNode<span class="token punctuation">.</span>next<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> curr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// newNode and reset to newNode</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// either fields of the root</span>
                 root<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> newNode<span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">// or next fields of newNode's</span>
            <span class="token keyword">else</span> prev<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>next<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> newNode<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// predecessors;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">王瀚文</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://han77520.github.io/2021/07/31/Redis/">http://han77520.github.io/2021/07/31/Redis/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">王瀚文</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'Tw1t1F755btODLVdHL3O30Xy-gzGzoHsz',
        appKey: 'kCKupgkz6MGJHgRBUMxT0ubD',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '想说点啥？Just go go ^_^'
    });
</script>

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/08/02/MyBatis%E5%A4%8D%E4%B9%A0/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="MyBatis">
                        
                        <span class="card-title">MyBatis</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            MyBatis
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-08-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/MyBatis/" class="post-category">
                                    MyBatis
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/25/%E4%B9%A6%E5%9F%8E%E9%A1%B9%E7%9B%AE/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/13.jpg" class="responsive-img" alt="书城项目">
                        
                        <span class="card-title">书城项目</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            书城项目
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E4%B9%A6%E5%9F%8E%E9%A1%B9%E7%9B%AE/" class="post-category">
                                    书城项目
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="2735927705"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2021</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">瀚77</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">347.2k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/han77520" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1721616038@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://space.bilibili.com/406750122" class="tooltipped" target="_blank" data-tooltip="在B站上关注我" " data-position="top" data-delay="50">
        <i class="fas fa-play-circle"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1721616038" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1721616038" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="https://gitee.com/wang-hanwen/git-test1/blob/master/WeChat.PNG" class="tooltipped" target="_blank" data-tooltip="微信联系我: 15110606054" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
    <script src="/"></script>
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
       

    <!--动态线条背景-->
<script type="text/javascript"
color="122 103 238" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<!-- 樱花-->
<script type="text/javascript" src="/js/sakura.js"></script>

<!-- 雪花 -->
<!-- <script type="text/javascript" src="/js/snow.js"></script> -->

<!-- 趣味标题 -->
<script type="text/javascript" src="/js/Title.js"></script>

</body>

</html>
